---
title: Monitors cpu, memory, specified process, and disk automatically
author: kmlee
date: 2023-08-16 16:30:00 +9
categories: [Blogging, Demo]
tags: [scripts]
---

정의
======================================

기능 요건은 아래와 같다.

    1. CPU 사용량 모니터링:
        현재 CPU 사용률을 퍼센트로 출력한다.
        CPU 사용률이 80% 이상일 경우, 경고 메시지를 출력한다.
    
    2. 메모리 사용량 모니터링:
        현재 사용 중인 RAM과 총 RAM을 출력한다.
        사용 가능한 RAM이 총 RAM의 20% 미만일 경우, 경고 메시지를 출력한다.
    
    3. 특정 프로세스 모니터링:
        '[project directory]/config' 파일에 모니터링할 파일들의 PID를 작성한다.
        해당 프로세스가 실행 중인지 확인하고, 그 상태(실행 중/실행되지 않음)메시지를 출력한다.
    
    4. 디스크 사용량 모니터링:
        각 마운트된 파티션의 사용량을 퍼센트로 출력한다.
        특정 파티션의 사용량이 90% 이상일 경우, 경고 메시지를 출력한다.

제한 요건은 아래와 같다.

    1. 시스템 상에서 스크립트가 매 2시간마다 자동으로 실행되도록 한다.

    2. 리눅스 기본 명령어만을 사용하여 구현한다. (특정 패키지 설치 X)

메시지 출력 '[project directory]/log' 에 저장하며,
경고 발생 시 사용자 표준출력에 표시한다.

구현 과정
======================================
첫번째 기능을 구현하기 위해 cpu 사용량과 관련된 명령, 혹은 시스템 파일에 대해 검색해보았다. cpu와 관련된 명령어를 3가지 정도 확인할 수 있었는데, 각 명령어가 본 스크립트의 요건에 부합하는지 확인해보았다.

'$lscpu'명령의 출력 상에서는 cpu spec에 대해서는 자세히 소개해주지만, cpu가 현재 진행 중인 작업 정보는 알 수 없다. 따라서 해당 방법은 사용할 수 없다. ('/proc/log' 파일 내 정보 또한 비슷한 역할을 한다.)

'$mpstat' 명령을 통해 아래와 같이 cpu 사용량을 쉽게 파악할 수 있다. 메뉴얼에 따르면, %idle 영역은 cpu의 유휴한 시간 백분율을 나타낸다고 나와있다. 따라서 100에서 %idle 영역의 값을 빼주면 가용중인 cpu 사용량을 계산할 수 있다고 하겠다. 하지만 mpstat 명령어는 리눅스 기본명령어에 포함되지 않으며 'sysstat' 패키지의 일부로 제공되는 명령어이다. 본 스크립트 구현의 제한조건에 따라서 해당 방법 또한 사용할 수 없다.
![result_command_mpstat](https://github.com/yesleekm/yesleekm.github.io/assets/54760524/4777ca5f-6ea1-4015-bdfd-b3133fc01407)
(mpstat 명령어 출력 결과)
![manual_command_mpstat_idle](https://github.com/yesleekm/yesleekm.github.io/assets/54760524/dcf623fa-bfe2-4ee4-b91e-cc7747b579e3)
(mpstat idle 필드 명세)

'$top' 명령을 통해 프로세스 정보를 실시간으로 터미널에 출력할 수 있는데, 해당 정보는 아래와 같이 나타난다. 해당 정보는 일정 시간마다 지속적으로 갱신된다. (아마 초 단위인 것 같다.) 메뉴얼에 따르면 '-n' 옵션을 통해 반복 횟수를 정할 수 있는데, 예를 들어 단 한 번만 정보를 표시하고 싶으면 '-n 1'이라고 정의하면 된다.
![result_command_top](https://github.com/yesleekm/yesleekm.github.io/assets/54760524/63675bf2-4d7e-42d2-88ff-64d7ca0bb280)
(top 명령어 출력 결과>)
![manual_command_top_option](https://github.com/yesleekm/yesleekm.github.io/assets/54760524/a88cd75d-351b-4070-aaae-6d4e735c2957)
(top 메뉴얼 상 - n 옵션 서술)

또한 '$top' 명령어내 3번째 줄에 있는 '%Cpu(s)' 필드 상에서는 Cpu 사용량에 대한 정보들이 나타난다. 필드 내의 각 항목에 대한 정의는 아래와 같은데, 그에 따르면 id 항목이 명시하는 값은 Cpu의 유휴 시간을 백분율로 나타낸 상태 값이라고 할 수 있다. 따라서 100에서 해당 값을 빼면 Cpu 사용량을 대략적으로라도 구할 수 있다고 판단하였다.
![result_command_top_cpufield](https://github.com/yesleekm/yesleekm.github.io/assets/54760524/c784d6cd-c177-4346-93de-18f3fdfc7c73)
<top 내 Cpu 필드>
![manual_command_top_cpusummary](https://github.com/yesleekm/yesleekm.github.io/assets/54760524/a9d3bc2c-fa38-44e5-be53-b810e80ec875)
<top 메뉴얼 상 cpu 필드 서술>
따라서 아래 명령어를 사용하여 '$top' 명령어 내 Cpu 정보 필드에 대한 id 값을 추출했다. 해당 정보는 명령어 출력 상 'Cpu(s)'가 명시된 행에서 띄어쓰기로 구분된 8번째 항목 상에 존재한다.
    top -n 1 | grep "Cpu(s)" | awk '{print $8}'
![result_command_top_id](https://github.com/yesleekm/yesleekm.github.io/assets/54760524/afe0598f-1686-4765-9a8a-abd990181c81)
<top -n 1 | grep "Cpu(s)" | awk '{print $8}' 실행 결과>

    구현 기간
    ======================================
    23.8.16~

    참고 사이트
    ======================================
    https://inpa.tistory.com/entry/LINUX-%F0%9F%93%9A-CPU-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EB%94%94%EC%8A%A4%ED%81%AC-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%B3%B4-%EB%AA%85%EB%A0%B9%EC%96%B4-%EC%B4%9D%EC%A0%95%EB%A6%AC
    https://blueyikim.tistory.com/555